<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPIROC DS-FLEET PARAMETER ENTRY FORM</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; padding: 20px; margin: 0; }
        .header-section { max-width: 700px; margin: 0 auto 10px auto; text-align: center; }
        .brand-logo { max-width: 160px; height: auto; margin-bottom: 10px; }
        h2 { margin: 0; font-size: 22px; color: #333; border-bottom: 2px solid #FFD700; padding-bottom: 10px; }
        .sheet-container { background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 700px; margin: 0 auto; border-radius: 8px; overflow: hidden; }
        table { border-collapse: collapse; width: 100%; }
        td { border: 1px solid #dfe3e8; padding: 12px; font-size: 14px; }
        .hidden { display: none !important; }
        .status-tag { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .locked { background: #f8d7da; color: #721c24; }
        .unlocked { background: #d4edda; color: #155724; }
        tr:nth-child(odd) .label-cell { background-color: #FFD700 !important; color: #000; font-weight: bold; width: 45%; }
        tr:nth-child(even) .label-cell { background-color: #555555 !important; color: #ffffff; font-weight: bold; width: 45%; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }
        .unlock-area { background: #fff3cd; padding: 15px; text-align: center; border-bottom: 2px solid #ffeeba; }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-unlock { background-color: #555; color: white; margin-left: 10px; }
        .btn-submit { background-color: #28a745; color: white; width: 100%; padding: 15px; font-size: 18px; }
        .sync-status { font-size: 11px; color: #28a745; font-weight: bold; display: none; padding: 5px; }
        .required-star { color: #dc3545; }
    </style>
</head>
<body>

    <div class="header-section">
        <img src="Picture1.png" alt="Epiroc Logo" class="brand-logo" onerror="this.style.display='none'">
        <h2>EPIROC DS-FLEET PARAMETER ENTRY FORM</h2>
    </div>

    <div class="sheet-container">
        <div class="unlock-area" id="lockZone">
            <input type="password" id="passInput" placeholder="Enter Unlock Password" style="width: 200px;">
            <button type="button" class="btn-unlock" onclick="validateLock()">Unlock Form</button>
            <span id="statusLabel" class="status-tag locked">Locked</span>
        </div>

        <form id="residencyForm" class="hidden">
            <input type="hidden" name="Fleet Source" value="DS Fleet (Form B)">
            <table>
                <tr><td class="label-cell">Customer Name <span class="required-star">*</span></td>
                    <td><select id="customerSelect" name="Customer Name" onchange="updateSites();" required>
                        <option value="">-- Select Customer --</option>
                        <option value="TATA STEEL LTD">TATA STEEL LTD</option>
                        <option value="NORTHERN COALFIELDS LTD">NORTHERN COALFIELDS LTD</option>
                        <option value="WESTERN COALFIELDS LTD">WESTERN COALFIELDS LTD</option>
                        <option value="EASTERN COALFIELDS LTD">EASTERN COALFIELDS LTD</option>
                        <option value="MAHANADI COALFIELDS LTD">MAHANADI COALFIELDS LTD</option>
                        <option value="THE SINGARENI COLLIERIES COMPANY LIMITED">THE SINGARENI COLLIERIES COMPANY LIMITED</option>
                        <option value="NMDC LTD">NMDC LTD</option>
                        <option value="SOUTH EASTERN COALFILEDS LTD">SOUTH EASTERN COALFILEDS LTD</option>
                        <option value="STEEL AUTHORITY OF INDIA LTD">STEEL AUTHORITY OF INDIA LTD</option>
                        <option value="BHARAT COKING COAL LIMITED">BHARAT COKING COAL LIMITED</option>
                        <option value="RELIANCE POWER">RELIANCE POWER</option>
                        <option value="JAIPRAKASH ASSOCIATES LTD">JAIPRAKASH ASSOCIATES LTD</option>
                        <option value="CENTRAL COALFIELDS LTD">CENTRAL COALFIELDS LTD</option> 
                    </select></td>
                </tr>
                <tr><td class="label-cell">Date <span class="required-star">*</span></td><td><input type="date" name="Date" id="valDate" onchange="fetchPreviousData();" required></td></tr>
                <tr><td class="label-cell">Technician Name <span class="required-star">*</span></td><td><input type="text" name="Technician Name" id="valTech" required></td></tr>
                <tr><td class="label-cell">Work Site <span class="required-star">*</span></td><td><select id="workSiteSelect" name="Work Site" onchange="updateFleet();" required><option value="">-- Select Site --</option></select></td></tr>
                <tr>
                    <td class="label-cell">Fleet ID <span class="required-star">*</span></td>
                    <td>
                        <select id="fleetSelect" name="Fleet" onchange="fetchPreviousData();" required><option value="">-- Select Fleet --</option></select>
                        <div id="syncStatus" class="sync-status"></div>
                    </td>
                </tr>
                <tr><td class="label-cell">Shift <span class="required-star">*</span></td><td><select name="Shift" required><option value="">-- Select Shift --</option><option>Shift A</option><option>Shift B</option><option>Shift C</option><option>G Shift</option></select></td></tr>
                
                <tr><td class="label-cell">Rotation Pressure</td><td><input type="number" step="any" name="Rotation Pressure" class="param-input"></td></tr>
                <tr><td class="label-cell">Engine Temp <span class="required-star">*</span></td><td><input type="number" step="any" name="Engine Temp" class="param-input" required></td></tr>
                <tr><td class="label-cell">Engine oil pressure <span class="required-star">*</span></td><td><input type="number" step="any" name="Engine oil pressure" class="param-input" required></td></tr>
                <tr><td class="label-cell">Rotation Pr Rod Joint</td><td><input type="number" step="any" name="Rotation Pr Rod To Rod" class="param-input"></td></tr>
            </table>
            
            <div style="padding: 20px;">
                <button type="submit" id="submitBtn" class="btn-submit">Submit Record</button>
            </div>
        </form>
    </div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbxv4dGi85Rv1ru6mqQ8Byr_4SuZX9KGJSX0ySkpCjnggFndowPMDTURlZRE1yCpeIgvVg/exec";
        const passKey = "Epiroc@123";

        function validateLock() {
            const input = document.getElementById('passInput').value;
            if (input === passKey) {
                document.getElementById('residencyForm').classList.remove('hidden');
                document.getElementById('lockZone').style.display = 'none';
            } else { alert("Incorrect Password"); }
        }

        async function fetchPreviousData() {
            const fleet = document.getElementById('fleetSelect').value;
            const date = document.getElementById('valDate').value;
            const status = document.getElementById('syncStatus');
            if (fleet && date) {
                status.style.display = 'block'; status.innerText = "⏳ Syncing previous data...";
                try {
                    const response = await fetch(`${scriptURL}?get=previousData&fleet=${encodeURIComponent(fleet)}&date=${date}`);
                    const result = await response.json();
                    if (!result.error) {
                        document.querySelectorAll('.param-input').forEach(input => {
                            if (result[input.name] !== undefined) input.value = result[input.name];
                        });
                        status.innerText = "✅ Values restored";
                    } else { status.innerText = "ℹ️ New entry"; }
                } catch (e) { status.innerText = "⚠️ Sync Error"; }
                setTimeout(() => { status.style.display = 'none'; }, 4000);
            }
        }

        const customerToSites = {
            "TATA STEEL LTD": ["Noamundi Iron Ore Mines", "Khondbond Iron Ore Mines", "Joda Iron Ore Mines"],
            "NORTHERN COALFIELDS LTD": ["Jayant Projects", "Khadia Project", "Nigahi Project", "Dudhichua Project", "Kakri Project", "Bina Projects", "Jhingurda Project", "Krishnasila Project", "Block B"],
            "WESTERN COALFIELDS LTD": ["Sasti OCM", "Umrer OCM", "Kamptee OCM", "Durgapur OCM", "Majri OCM", "NMOC OCM", "Ukni OCM", "Mungoli OCM", "Junad OCM", "Penganga OCM", "Naigaon OCM", "Namug OCM"],
            "EASTERN COALFIELDS LTD": ["BANJEMEHARI OCP", "SP MINES-CHITRA", "BARMURI OCP-MUGMA", "SANKARPUR OCP", "GAURANDI OCP", "NAKRAKONDA OCP", "RAJMAHAL OCP", "KOTTADIH OCP"],
            "NMDC LTD": ["BACHELI", "KIRANDUL", "Donimalai"],
            "MAHANADI COALFIELDS LTD": ["LAKHANPUR OCP", "ANANTA OCP", "LINGARAJ OCP", "JAGANNATH OCP", "GARJANBAHAL OCP", "LAJKURA OCP"],
            "THE SINGARENI COLLIERIES COMPANY LIMITED": ["PKOC2,Manuguru", "OC3,RG2 Area", "OC1,RG3 Area", "SCCL/JVR OC satupally", "SCCL/RGIII-OC2", "SCCL/RGII-OC3"],
            "SOUTH EASTERN COALFILEDS LTD": ["DIPKA PROJECT", "KUSHMUNDA PROJECT", "GEVRA PROJECT"],
            "STEEL AUTHORITY OF INDIA LTD": ["BARSUA IRON MINES", "BOLANI IRON ORE MINES", "Meghahatuburu Iron Mines", "Kiriburu Iron Ore Mines", "Gua Ore Mines", "RAJHARA MINES", "Dalli Rajhara - Bhilai", "NANDINI MINES", "JHARAN DALLI MINES"],
            "BHARAT COKING COAL LIMITED": ["Nichitpur Project", "Akashkinaree Project", "BASANTIMATA-DAIBARI OCP", "AKWM OCP", "Viswakarma Project", "Dahibari Project", "Muraidih OCP", "New Akshkinaree OCP", "Sadabti Project", "SOCP-BARORA AREA-1", "Kunya OCP", "ABOCP-BLOCK II AREA", "Dahibari OCP", "Block II OCP", "Block IV OCP"],
            "RELIANCE POWER": ["Muher & Muher Project"],
            "JAIPRAKASH ASSOCIATES LTD": ["Manguli Site"],
            "CENTRAL COALFIELDS LTD": ["Jharkhand Project", "SD OCM Project", "Purnadih Project", "Topa Site", "Katara Project, CCL", "Birsa Project", "Rajrappa Project", "Piparwar Project", "Dakra Project", "Swang Project", "Urimari Project", "KDH Project", "Religara Project", "Tarmi Project", "Ashok Project", "Rohini Project", "Karo Project", "Tapin North Project", "Khasmahal Project", "Giddi C Project", "Pundi Project", "Kedla Project", "Parej East Project", "Amlo Project"]
        };

        const siteToFleet = {
            "Noamundi Iron Ore Mines": ["IDM45D-201608031"],
            "Khondbond Iron Ore Mines": ["IDM45D-201408029", "IDM45D-201408028"],
            "Joda Iron Ore Mines": ["IDM45D-201408030"],
            "Jayant Projects": ["IDM30-202006955", "IDM30-202006951", "IDM30-202006953", "IDM30-202006954", "IDM30-202006952", "IDM30-201306795", "IDM30-201306802", "IDM30-201306801", "IDM30-201306799"],
            "PKOC2,Manuguru": ["IDM30-201806914", "IDM30-202006943"],
            "ABOCP-BLOCK II AREA": ["IDM30-202206984"],
            "Dahibari OCP": ["IDM30-202506995"],
            "Amlo Project": ["IDM30-201506853"]
        };

        function updateSites() {
            const customer = document.getElementById('customerSelect').value;
            const siteSelect = document.getElementById('workSiteSelect');
            siteSelect.innerHTML = '<option value="">-- Select Site --</option>';
            if (customerToSites[customer]) {
                customerToSites[customer].forEach(s => {
                    let opt = document.createElement('option'); opt.value = opt.text = s; siteSelect.add(opt);
                });
            }
        }

        function updateFleet() {
            const site = document.getElementById('workSiteSelect').value;
            const fleetSelect = document.getElementById('fleetSelect');
            fleetSelect.innerHTML = '<option value="">-- Select Fleet --</option>';
            if (siteToFleet[site]) {
                siteToFleet[site].forEach(f => {
                    let opt = document.createElement('option'); opt.value = opt.text = f; fleetSelect.add(opt);
                });
            }
        }

        document.getElementById('residencyForm').addEventListener('submit', e => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = "Submitting..."; btn.disabled = true;
            fetch(scriptURL, { method: 'POST', body: new FormData(e.target)})
            .then(() => { alert("Success! Data Saved."); location.reload(); })
            .catch(() => { alert("Submission Failed."); btn.disabled = false; btn.innerText = "Submit Record"; });
        });
    </script>
</body>
</html>
